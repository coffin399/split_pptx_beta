name: PowerPoint å¤‰æ›ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'PPTXãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLï¼ˆå…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚‚ã®ï¼‰'
        required: true
        type: string
      dpi:
        description: 'ã‚µãƒ ãƒã‚¤ãƒ«ç”¨DPIï¼ˆ50-150ï¼‰'
        required: false
        default: '100'
        type: string

jobs:
  convert:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice poppler-utils fonts-noto-cjk
        
    - name: Pythonä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        pip install -r requirements_web.txt
        pip install psutil
        
    - name: ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
      run: |
        mkdir -p uploads temp output
        
    - name: PPTXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      run: |
        DOWNLOAD_URL="${{ github.event.inputs.file_url }}"

        # Google Slides ã®å…±æœ‰URLã«å¯¾å¿œï¼ˆ/presentation/d/<ID>/edit å½¢å¼ï¼‰
        if echo "$DOWNLOAD_URL" | grep -q "docs.google.com/presentation"; then
          echo "Google Slides ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’å¤‰æ›ã—ã¦ã„ã¾ã™..."
          SLIDE_ID=$(echo "$DOWNLOAD_URL" | sed -n 's#.*/presentation/d/\([^/]*\)/.*#\1#p')
          if [ -n "$SLIDE_ID" ]; then
            DOWNLOAD_URL="https://docs.google.com/presentation/d/$SLIDE_ID/export/pptx"
            echo "å¤‰æ›å¾Œã®URL: $DOWNLOAD_URL"
          else
            echo "âŒ Google Slides ã®URLã‹ã‚‰IDã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å…±æœ‰ãƒªãƒ³ã‚¯å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi
        fi

        curl -L "$DOWNLOAD_URL" -o uploads/input.pptx
        if [ ! -s uploads/input.pptx ]; then
          echo "âŒ PPTXãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚URLãŒæ­£ã—ã„ã‹ã€å…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          exit 1
        fi
        
    - name: PowerPointã‚’å¤‰æ›
      env:
        DPI: ${{ github.event.inputs.dpi }}
      run: |
        python3 <<'PY'
        import os
        import sys
        import time
        import shutil
        import json
        import threading
        from statistics import mean
        from pathlib import Path

        sys.path.append('.')
        from app import generate_script_slides
        import psutil

        # Set DPI from input
        os.environ['THUMBNAIL_DPI'] = os.getenv('DPI', '100')

        def reporter(message: str) -> None:
            timestamp = time.strftime('%Y-%m-%d %H:%M:%S')
            print(f"[{timestamp}] {message}")

        process = psutil.Process(os.getpid())
        memory_samples = []
        stop_event = threading.Event()

        def sample_memory() -> None:
            while not stop_event.is_set():
                rss_mb = process.memory_info().rss / (1024 * 1024)
                memory_samples.append(rss_mb)
                time.sleep(1)

        sampler = threading.Thread(target=sample_memory, daemon=True)
        sampler.start()

        # Convert file
        input_path = Path('uploads/input.pptx')
        output_dir = Path('output')
        output_dir.mkdir(parents=True, exist_ok=True)

        try:
            output_path = generate_script_slides(input_path, Path('temp'), reporter)
            print(f"Output: {output_path}")

            # Copy to output directory
            shutil.copy2(output_path, output_dir / 'converted.pptx')
            print('Conversion completed successfully!')
        finally:
            stop_event.set()
            sampler.join(timeout=2)
            memory_samples.append(process.memory_info().rss / (1024 * 1024))

            if not memory_samples:
                current_mb = process.memory_info().rss / (1024 * 1024)
                memory_samples.append(current_mb)

            min_mem = min(memory_samples)
            max_mem = max(memory_samples)
            avg_mem = mean(memory_samples)
            stats = {
                "unit": "MB",
                "sample_count": len(memory_samples),
                "min": round(min_mem, 2),
                "max": round(max_mem, 2),
                "avg": round(avg_mem, 2),
            }

            stats_json_path = output_dir / 'memory_stats.json'
            stats_txt_path = output_dir / 'memory_stats.txt'

            with stats_json_path.open('w', encoding='utf-8') as f:
                json.dump(stats, f, ensure_ascii=False, indent=2)

            with stats_txt_path.open('w', encoding='utf-8') as f:
                f.write('min: {min:.2f} MB\n'.format(**stats))
                f.write('avg: {avg:.2f} MB\n'.format(**stats))
                f.write('max: {max:.2f} MB\n'.format(**stats))
                f.write(f'samples: {stats["sample_count"]}\n')

            print('Memory usage stats (MB):', stats)
        PY
        
    - name: çµæœãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: converted-presentation
        path: output/
        retention-days: 1
        
    - name: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¡ˆå†…ã‚’ä½œæˆ
      run: |
        echo "## ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "å¤‰æ›æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f output/memory_stats.txt ]; then
          echo "### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ (MB)" >> $GITHUB_STEP_SUMMARY
          cat output/memory_stats.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        echo "1. ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã® **Actions** ã‚¿ãƒ–ã‚’é–‹ãã¾ã™" >> $GITHUB_STEP_SUMMARY
        echo "2. ä»Šå›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™" >> $GITHUB_STEP_SUMMARY
        echo "3. **converted-presentation** ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° ãƒ•ã‚¡ã‚¤ãƒ«ã¯1æ—¥é–“ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™" >> $GITHUB_STEP_SUMMARY
